---
layout: default
title: Evaluate a CosmicOS-like expression
extra_js: js/jqconsole.js
extra_css: css/jqconsole.css
---

<h2>Test console</h2>

<p>
  This is a console for testing out expressions in
  the minimal programming language CosmicOS starts off with.
  Type <tt>help</tt> for a sketch of the syntax, and
  <tt>examples</tt> for some expressions to try out.
</p>

<div id="console-wrap"><div id="console"></div></div>


<script>

 function CosCon() {
   this.state = null;
   this.mem = {};
   this.numeric = {};
   this.numericRev = {};
   this.numericAt = 0;
   this.explain = {};
   this.example = {};
   this.contxt = "";
 }
 
 CosCon.prototype.builtins = [
   { name: "?", value: null, tip: "create an anonymous function", example: "? x / - $x 1" },
   { name: "@", value: null, tip: "store an expression in memory", example: "@ dec / ? x / - $x 1" },
   { name: "if", value: null, tip: "conditional evaluation", example: "if (> $x 0) (dec $x) $x" },
   {
     name: "+",
     value: function (x) { return function (y) { return x+y; } },
     tip: "add two integers",
     example: "+ 22 20"
   },
   {
     name: "-",
     value: function (x) { return function (y) { return x-y; } },
     tip: "subtract one integer from other",
     example: "- 44 2"
   },
   {
     name: "=",
     value: function (x) { return function (y) { return (x==y)?1:0; } },
     tip: "test for integer equality",
     example: "= 42 41"
   },
   {
     name: "*",
     value: function (x) { return function (y) { return x*y; } },
     tip: "multiply two integers",
     example: "* 2 21"
   },
   {
     name: "<",
     value: function (x) { return function (y) { return (x<y)?1:0; } },
     tip: "is one integer less than other",
     example: "< 41 42"
   },
   {
     name: ">",
     value: function (x) { return function (y) { return (x>y)?1:0; } },
     tip: "is one greater than other",
     example: "> 42 41"
   }
 ];

 CosCon.prototype.examples = [
   "+ 3 (* 10 2);",
   "+ 3 / * 10 2;",
   "+ 3 18;",
   "@ square / ? x / * $x $x;",
   "square 10;",
   "@ factorial / ? n / if (= $n 0) 1 / * $n / factorial (- $n 1);",
   "factorial 5;",
   "@ first / ? x / ? y / x;",
   "@ second / ? x / ? y / y;",
   "@ cons / ? x / ? y / ? f / f $x $y;",
   "@ car / ? f / f $first;",
   "@ cdr / ? f / f $second;",
   "car / cons 10 15;",
   "cdr / cons 10 15;"
 ];

 CosCon.prototype.additions = [
  "@ not / ? x / if $x 0 1;",
  "@ and / ? x / ? y / if $x $y 0;",
  "@ or / ? x / ? y / if $x 1 $y;"
 ];

 CosCon.prototype.addNumeric = function(name) {
   if (this.numeric[name]==null) {
     this.numeric[name] = this.numericAt;
     this.numericRev[this.numericAt] = name;
     this.explain[this.numericAt] = "(used in an expression, no meaning assigned)";
     this.numericAt++;
   }
   return this.numeric[name];
 }

 CosCon.prototype.isList = function(x) {
   return x && typeof x=='object' && x.constructor==Array;
 }
 
 CosCon.prototype.stringToList = function(x) {
   var result = [];
   x = " " + x + " )";
   var cache = "";
   var level = 0;
   for (var i=0; i<x.length; i++) {
     var ch = x.charAt(i);
     if (ch=='\n'||ch=='\r'||ch==';') ch = ' ';
     if (ch=='(') {
       level++;
       if (level==1) continue;
     }
     if (ch=='/' && level==0) {
       level = 1;
       continue;
     }
     if (ch==')') {
       level--;
       if (level==0) {
	 result.push(this.stringToList(cache));
	 cache = "";
	 continue;
       }
     }
     if (ch!=' '||level>0) cache += ch;
     if (level==0&&ch==' '&&cache.length>0) {
       if (cache.charAt(0)=='$') {
	 cache = cache.substr(1,cache.length-1);
	 result.push([cache]);
       } else {
	 result.push(cache);
       }
       if (isNaN(parseInt(cache))) this.addNumeric(cache);
       cache = "";
     }
   }
   return result;
 }

 CosCon.prototype.setup = function() {
   for (var i=0; i<this.builtins.length; i++) {
     var b = this.builtins[i];
     var code = this.addNumeric(b.name);
     this.mem[code] = b.value;
     this.explain[code] = b.tip;
     this.example[code] = b.example;
   }
   for (var i=0; i<this.additions.length; i++) {
     this.process(this.additions[i]);
   }
 }

 CosCon.prototype.evaluate = function(e,c) {
   var self = this;
   if (self.isList(e)) {
     var x = e[0];
     x = self.evaluate(x,c);
     if (x==0) { // ?
       var k2 = self.evaluate(e[1],c);
       var e2 = e[2];
       x = function(v) {
	 var c2 = function(k) {
	   if (k==k2) return v;
	   else return c(k);
         }
	 return self.evaluate(e2,c2);
       };
     } else if (x==1) { // @
       var k2 = e[1];
       var v2 = self.evaluate(e[2],c);
       var code = self.evaluate(k2,c);
       self.mem[code] = v2;
       self.explain[code] = self.contxt;
       return null;
     } else if (x==2) { // if
       var choice = self.evaluate(e[1],c);
       if (choice!=0) {
 	 return self.evaluate(e[2],c);
       } else {
  	 return self.evaluate(e[3],c);
       }
     } else {
       if (typeof x == 'number') {
         x = c(x);
       }
       for (var i=1; i<e.length; i++) {
         x = x(self.evaluate(e[i],c));
       }
     }
     return x;
   } else if (typeof e == "string") {
     var v = parseInt(e);
     if (isNaN(v)) {
       v = self.addNumeric(e);
     }
     return v;
   }
   return e;
 }

 CosCon.prototype.evaluateMain = function(e) {
   var self = this;
   return this.evaluate(e,function(k) { return self.mem[k]; });
 }

 CosCon.prototype.process = function(str) {
   var lines = str.split(";");
   var txt = "";
   for (var i=0; i<lines.length; i++) {
     this.contxt = lines[i];
     if (this.contxt=="") continue;
     if (i>0) txt += "\n";
     var v = this.evaluateMain(this.stringToList(this.contxt));
     if (!(typeof v == "number")) {
       v = "mu";
     }
     txt += v;
   }
   return txt;
 }

 var jqconsole = null;
 var startPrompt = null;
 var cc = null;

 $(function () {
   cc = new CosCon();
   cc.setup();
 
   jqconsole = $('#console').jqconsole('Welcome to a CosmicOS test console, "help" and "examples" available\n', '>>> ');
   startPrompt = function () {
     jqconsole.Prompt(true, function (input) {
       $("#cos_foo").val(input);
       var out = "";
       try {
	 if (input=="help") {
	   out+= "Syntax:\n";
	   out+= "  Space-separated lists of integers with nesting e.g.: 1 2 3 (4 5) (6 7 (8 9))\n";
	   out+= "  Shorthand: symbols (listed below) can be used to stand for integers.\n";
	   out+= "  Shorthand: \"$x\" is equivalent to \"(x)\"\n";
	   out+= "  Shorthand: \"/\" nests to end of expression: (1 2 / 3 4) is equiv. to (1 2 (3 4))\n";
	   out+= "  Lists are evaluated by calling the first element with each of the others in turn.\n";
	   out+= "  If the first element of the list is a number, it is treated as a variable lookup.\n";
	   out+= "Index Symbol  Meaning                           Example\n";
	   for (var i=0; i<cc.numericAt; i++) {
	     var idx = "" + i;
	     for (var j=idx.length; j<5; j++) {
	       out += " ";
	     }
	     out += idx;
	     out += " ";
	     var name = "" + cc.numericRev[i];
	     out += name;
	     for (var j=name.length; j<7; j++) {
	       out += " ";
	     }
	     var e = cc.explain[idx];
	     if (e) {
	       out += " " + e;
	       for (var j=e.length; j<33; j++) {
		 out += " ";
	       }
	       var ex = cc.example[idx];
	       if (ex) {
		 out += " " + ex;
	       }
	       out += "\n";
	     }
	   }
	 } else if (input=="examples") {
	   for (var i=0; i<cc.examples.length; i++) {
	     out += "  " + cc.examples[i] + "\n";
	   }
	 } else {
	   out = cc.process(input) + "\n";
	 }
       } catch (e) {
	 out = e + "\n";
       }
       jqconsole.Write(out, 'jqconsole-output');
       startPrompt();
     });
   };
   startPrompt();
   jqconsole.Focus();
 });


 $(function() {
   $("#console").click(function() {  
     jqconsole.Focus();  
   })
 });

</script>
